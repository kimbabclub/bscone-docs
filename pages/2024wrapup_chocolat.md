# 2024 버터스콘 연말 회고 - 오븐

## 오븐 정비 회고

안녕하세요 버터스콘의 기술을 담당하고 있는 쇼콜라입니다.

작년 7월, 당시 한창 운영 중이던 버터스콘에 조금 더 전문적인 기술 지원이 필요해짐에 따라 본격적으로 합류하였습니다. 그리고 이번 회고에서는 그 동안 발견한 문제들과 향후 개선 방향을 한번 적어보고자 합니다.

### 데이터베이스 무결성 오류

> 동일한 리모트 유저가 중복으로 생성되는 오류가 발생합니다.
> 

합류 당시 버터스콘은 이미 운영을 하고 있는 상태였기에, 미스키의 자체적인 버그 정도로 파악을 하고 있었습니다. 그리고 몇가지 가설을 세웠습니다.

1. 미스키에서 중복 처리를 놓친 부분이 있다
2. 락을 걸지 않고 큐에서 동시에 생성을 진행하였다

2번 가설은 중복되는 각각의 유저 데이터가 생성된 시각이 확연히 차이가 났기에 바로 1번 가설을 전제하에 미스키 코드를 살펴보았습니다.

하지만 미스키에서 중복 처리는 당연하게도 데이터베이스에 `UNIQUE INDEX` 를 걸어둠으로써 방지하고 있었습니다.

구축 이후부터 합류까지 기간에 대한 버터스콘의 기술적인 정보가 없었기 때문에 “이 당시부터 데이터베이스에 문제가 있었을 수도 있겠다” 가정하였고, 데이터베이스에 접근하여 살펴보게 되었습니다.

<aside>
💡

프로덕션 서버의 데이터베이스 작업은 여러 위험성들로 인해 부담이 높은 작업이기에 필요 시 데이터를 제한적으로 살펴보는 과정으로 진행하고 있습니다.

당연한 이야기이지만, 문제를 해결하는 데에 필요한 데이터 이외에는 **절대** 확인하지 않습니다.

</aside>

확인 결과, 유저 테이블에 `UNIQUE INDEX`가 누락되어 있는 것을 파악하였고, 무결성 복구 작업을 시작하였습니다.

노트와 리액션 등의 데이터를 한 계정으로 마이그레이션 하였고, 중복으로 생성된 리모트 유저를 삭제한 뒤, 인덱스를 추가하여 정상적으로 작동하는 것을 확인하였습니다.

다른 테이블에서도 누락된 인덱스가 있는것을 추가적으로 확인하여 위와 비슷한 방법으로 복구를 진행하였습니다.

오류는 해결 되었으나, 두가지 의문이 남은 채로 마무리 되었습니다.

- init 마이그레이션 실행 당시 어째서 일부 인덱스가 누락되었는가?
- 이미 존재하는 리모트 유저를 가져오지 않고 왜 다시 생성을 시도하였는가?

### 계정 청소 기능

> @ai@buttersc.one: 오븐이 따뜻한 것 같아요... 괜찮을까요？
@oven@buttersc.one: [전소됨] (CPU = 100%)
> 

버터스콘 포크에 추가된 기능으로, 계정의 노트와 드라이브를 지우는 작업을 진행합니다.

다만 개발을 진행할 시간적 여유가 부족해, 부하를 분산하기 위한 방법을 적용하지 못했습니다. 그래서 몇 번의 계정 청소가 진행되었던 것을 확인하고 실시간으로 모니터링해 보았으나 크게 서버에 영향을 미치지 않았기에 급한 사안은 아니라고 판단하였습니다.

그러나 지난 10월 24일, 계정 청소 진행으로 인하여 수만개의 노트 일괄 삭제가 발생하였고, 연합우주의 특성상 노트가 전파된 연합 인스턴스 전체에게 삭제 요청을 전송해야 하기에 실제 `deliver` 큐에는 170만개 가량의 요청이 쌓여 일시적으로 버터스콘에서 작성한 노트와 리액션 같은 상호작용의 전파가 지연되었습니다.

이 문제는 인지하고 있는 상태이고, 추후 삭제 큐의 분리 또는 후순위 처리하도록 개선할 예정입니다.

### 서버 확장

미스키는 검색 엔진으로 meilisearch를 사용하고 있습니다. 현재 버터스콘 서비스에서 가장 많은 리소스를 차지하고 있는 부분이기도 합니다.

이용자 수가 증가함에 따라 자연스럽게 meilisearch 리소스 사용량도 증가하였고, 올해 1~2분기 사이부터는 입/출력에서 병목이 발생하고 있는 상황이기에 확장이 불가피한 상황이 되었습니다.

비용, 성능, 안정성을 고려하여 우선적으로 확장할 수 있는 방법부터 차근차근 진행할 예정입니다.

이외에도 간헐적인 로딩 지연 문제 등의 퍼포먼스 이슈를 내년에는 해결해보고자 합니다.

### 버터스콘 포크에 관하여

미스키의 기능적으로 불편한 사항들에 대해 피드백을 받아 하나씩 개선하여 운영하다 보니 미스키 기반의 포크중 하나로써 여러 서버에서 버터스콘 포크를 이용해주시고 있습니다.

버터스콘 포크는 AGPL-3.0 라이센스의 조건 이내에서 자유롭게 이용/수정이 가능하며 운영진을 통해 기능 건의 또한 자유롭게 해주실 수 있습니다. (시간적 여유가 있을 때 개발 후 추가됩니다..)

버터스콘에서 수정하여 사용중인 소스 코드는 [이곳](https://github.com/ZerglingGo/misskey)에서 확인하실 수 있습니다.

사실 마무리에 버터스콘의 1년치 메트릭 데이터를 첨부하고 싶었으나, 메트릭 데이터를 수집하고 있던 오븐이 불타버려서 데이터가 소실된 관계로… 내년에 기회가 된다면 첨부해 보도록 하겠습니다. 감사합니다.